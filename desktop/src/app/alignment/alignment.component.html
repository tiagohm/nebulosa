<div class="container px-4 py-3">
    <div class="grid">
        <div class="col-12 align-items-center justify-content-center gap-2">
            <neb-device-list-button title="CAMERA" icon="mdi mdi-camera-iris" [devices]="cameras" [(device)]="camera"
                                    (deviceChange)="cameraChanged()" />
            <p-button [disabled]="!camera.name || running" icon="mdi mdi-cog" (onClick)="showCameraDialog()" size="small" />
            @if (tab === 0) {
            <neb-device-list-button title="MOUNT" icon="mdi mdi-telescope" [devices]="mounts" [(device)]="mount" (deviceChange)="mountChanged()" />
            <p-button *ngIf="mount.connected" [disabled]="!mount.name || running" (onClick)="mountConnect()" icon="mdi mdi-close"
                      size="small" severity="danger" pTooltip="Disconnect" tooltipPosition="bottom" [text]="true" />
            <p-button *ngIf="!mount.connected" [disabled]="!mount.name || running" (onClick)="mountConnect()" icon="mdi mdi-connection"
                      size="small" severity="info" pTooltip="Connect" tooltipPosition="bottom" [text]="true" />
            } @else {
            <neb-device-list-button title="GUIDE OUTPUT" icon="mdi mdi-target" [devices]="guideOutputs" [(device)]="guideOutput"
                                    (deviceChange)="guideOutputChanged()" />
            <p-button *ngIf="guideOutput.connected" [disabled]="!guideOutput.name || running" (onClick)="guideOutputConnect()"
                      icon="mdi mdi-close" size="small" severity="danger" pTooltip="Disconnect" tooltipPosition="bottom" [text]="true" />
            <p-button *ngIf="!guideOutput.connected" [disabled]="!guideOutput.name || running" (onClick)="guideOutputConnect()"
                      icon="mdi mdi-connection" size="small" severity="info" pTooltip="Connect" tooltipPosition="bottom" [text]="true" />
            }
        </div>
        <div class="col-12 relative pt-0 text-sm text-gray-400 flex align-items-center mt-1 gap-1 text-sm" style="min-height: 25px;">
            <neb-camera-exposure #cameraExposure [info]="status" />

            <div *ngIf="alignmentMethod === 'TPPA'" class="absolute flex flex-row align-items-center gap-1" style="right: 8px; top: -2px">
                <p-tag value="RA: {{ tppaRightAscension }}" [severity]="tppaFailed ? 'danger' : 'info'" />
                <p-tag value="DEC: {{ tppaDeclination }}" [severity]="tppaFailed ? 'danger' : 'info'" />
            </div>
        </div>
    </div>
    <div class="grid">
        <div class="col-12">
            <p-tabView [(activeIndex)]="tab">
                <p-tabPanel header="TPPA">
                    <div class="grid mt-3">
                        <div class="col-5 gap-2 align-items-center">
                            <span class="p-float-label">
                                <p-dropdown [options]="plateSolverTypes" [(ngModel)]="tppaRequest.plateSolver.type" [autoDisplayFirst]="false"
                                            styleClass="p-inputtext-sm border-0" (ngModelChange)="plateSolverChanged()" />
                                <label>Plate Solver</label>
                            </span>
                        </div>
                        <div class="col-4 align-items-center">
                            <span class="p-float-label">
                                <p-inputNumber styleClass="p-inputtext-sm border-0 max-w-full" [(ngModel)]="tppaRequest.stepDuration"
                                               [showButtons]="true" [min]="1" [max]="60" (ngModelChange)="savePreference()" />
                                <label>Step duration (s)</label>
                            </span>
                        </div>
                        <div class="col-3 flex flex-column align-items-center justify-content-start">
                            <span class="p-float-label">
                                <p-dropdown [options]="['EAST', 'WEST']" [(ngModel)]="tppaRequest.stepDirection" styleClass="p-inputtext-sm border-0"
                                            [autoDisplayFirst]="false" (ngModelChange)="savePreference()" />
                                <label>Direction</label>
                            </span>
                        </div>
                        <div class="col-4 align-items-center">
                            <span class="p-float-label">
                                <p-dropdown [disabled]="!mount.connected" [options]="mount.slewRates" [(ngModel)]="tppaRequest.stepSpeed"
                                            styleClass="p-inputtext-sm border-0" optionLabel="label" optionValue="name"
                                            [autoDisplayFirst]="false" (ngModelChange)="savePreference()" />
                                <label>Step speed</label>
                            </span>
                        </div>
                        <div class="col-4 flex align-items-center justify-content-center text-center gap-2 text-sm">
                            <p-checkbox [binary]="true" [(ngModel)]="tppaRequest.stopTrackingWhenDone" label="Stop tracking when done"
                                        (ngModelChange)="savePreference()" />
                        </div>
                        <div class="col-4 flex align-items-center justify-content-center text-center gap-2 text-sm">
                            <p-checkbox [binary]="true" [(ngModel)]="tppaRequest.compensateRefraction" label="Compensate refraction"
                                        (ngModelChange)="savePreference()" />
                        </div>
                    </div>
                    <div class="grid mt-2">
                        <div class="col-4 flex flex-column align-items-center justify-content-center">
                            <span class="font-bold">Azimuth</span>
                            <span class="text-lg">{{ tppaAzimuthError }}</span>
                            <span class="text-md">{{ tppaAzimuthErrorDirection }}</span>
                        </div>
                        <div class="col-4 flex flex-column align-items-center justify-content-center">
                            <span class="font-bold">Altitude</span>
                            <span class="text-lg">{{ tppaAltitudeError }}</span>
                            <span class="text-md">{{ tppaAltitudeErrorDirection }}</span>
                        </div>
                        <div class="col-4 flex flex-column align-items-center justify-content-center">
                            <span class="font-bold">Total</span>
                            <span class="text-lg">{{ tppaTotalError }}</span>
                        </div>
                    </div>
                    <div class="grid mt-2">
                        <div class="col-12 flex align-items-center justify-content-center gap-1">
                            <p-button [disabled]="!camera.connected || !mount.connected || mount.parked || mount.parking || mount.slewing || running"
                                      label="Start" (onClick)="tppaStart()" icon="mdi mdi-play" severity="success" size="small" />
                            <p-button [disabled]="!camera.connected || !mount.connected || !running" label="Abort" (onClick)="tppaStop()"
                                      icon="mdi mdi-stop" severity="danger" size="small" />
                            <p-button [disabled]="!camera.connected" (onClick)="openCameraImage()" icon="mdi mdi-image" [text]="true"
                                      styleClass="ml-4" pTooltip="View image" tooltipPosition="bottom" size="small" />
                        </div>
                    </div>
                </p-tabPanel>
                <p-tabPanel header="DARV">
                    <div class="grid mt-3">
                        <div class="col-4">
                            <span class="p-float-label">
                                <p-inputNumber styleClass="p-inputtext-sm border-0 max-w-full" [(ngModel)]="darvRequest.initialPause"
                                               [showButtons]="true" [min]="1" [max]="60" (ngModelChange)="initialPauseChanged()" />
                                <label>Initial pause (s)</label>
                            </span>
                        </div>
                        <div class="col-4">
                            <span class="p-float-label">
                                <p-inputNumber styleClass="p-inputtext-sm border-0 max-w-full" [(ngModel)]="darvRequest.exposureTime"
                                               [showButtons]="true" [min]="1" [max]="600" (ngModelChange)="driftForChanged()" />
                                <label>Drift for (s)</label>
                            </span>
                        </div>
                        <div class="col-4">
                            <span class="p-float-label">
                                <p-dropdown [options]="['NORTHERN', 'SOUTHERN']" [(ngModel)]="darvHemisphere" styleClass="p-inputtext-sm border-0"
                                            [autoDisplayFirst]="false" (ngModelChange)="savePreference()" />
                                <label>Hemisphere</label>
                            </span>
                        </div>
                    </div>
                    <div class="grid mt-2">
                        <div class="col-12 flex align-items-center justify-content-center gap-1">
                            <p-button [disabled]="!camera.connected || !guideOutput.connected || running" label="Start" (onClick)="darvStart()"
                                      icon="mdi mdi-play" severity="success" size="small" />
                            <p-button [disabled]="!camera.connected || !guideOutput.connected || !running" label="Abort" (onClick)="darvStop()"
                                      icon="mdi mdi-stop" severity="danger" size="small" />
                            <p-button [disabled]="!camera.connected" (onClick)="openCameraImage()" icon="mdi mdi-image" [text]="true"
                                      styleClass="ml-4" pTooltip="View image" tooltipPosition="bottom" size="small" />
                        </div>
                    </div>
                    <div class="grid mt-1">
                        <div class="col-12 flex-column justify-content-center text-sm overflow-y-auto max-h-7rem p-0">
                            <span>1. Locate a star in the Meridian and close to declination 0.</span>
                            <span>2. Start DARV and wait for routine to complete.</span>
                            <span>3. If you see V shaped track, adjust the Azimuth and repeat the step 2 till you get a line.</span>
                            <span>4. Locate a star in the Eastern or Western horizon and close to declination 0.</span>
                            <span>5. Start DARV and wait for routine to complete.</span>
                            <span>6. If you see V shaped track, adjust the Altitude and repeat the step 5 till you get a line.</span>
                            <span>7. Increase the drift time and repeat the step 1 to get a more accurate alignment.</span>
                        </div>
                    </div>
                </p-tabPanel>
            </p-tabView>
        </div>
    </div>
</div>