<div class="container px-4 pt-4">
	<div class="grid flex justify-content-center align-items-center">
		<div class="col-12 px-2 gap-1">
			<neb-button
				(action)="addConnection()"
				icon="mdi mdi-plus"
				severity="success"
				tooltip="New connection" />
			<p-floatLabel class="w-full">
				<p-dropdown
					[disabled]="connected"
					[options]="preference.connections"
					[(ngModel)]="connection"
					styleClass="border-0 p-inputtext-sm w-full"
					[autoDisplayFirst]="false"
					emptyMessage="No connection found">
					<ng-template
						let-item
						pTemplate="selectedItem">
						<div class="flex flex-row justify-content-between gap-1">
							<span>{{ connection?.name }}</span>
						</div>
					</ng-template>
					<ng-template
						let-item
						pTemplate="item">
						<div class="flex flex-row align-items-center justify-content-between gap-1 text-xs">
							<div class="flex flex-column gap-1">
								<span class="font-bold text-lg">{{ item.name }}</span>
								<span class="text-sm">{{ item.type }} | {{ item.host }}:{{ item.port }}</span>
								<div class="flex flex-row align-items-center gap-1 text-xs">
									<i class="mdi mdi-sm mdi-clock"></i>
									<span>{{ (item.connectedAt | date: 'yyyy-MM-dd HH:mm:ss') ?? 'never' }}</span>
								</div>
							</div>
							<div class="flex flex-column gap-3">
								<i
									class="mdi mdi-18px mdi-pencil"
									pTooltip="Edit"
									tooltipPosition="bottom"
									(click)="editConnection(item, $event)"></i>
								<i
									class="mdi mdi-18px mdi-close"
									pTooltip="Remove"
									tooltipPosition="bottom"
									(click)="deleteConnection(item, $event)"></i>
							</div>
						</div>
					</ng-template>
				</p-dropdown>
				<label>Connection</label>
			</p-floatLabel>
			<neb-button
				*ngIf="!connected"
				[disabled]="!connection"
				(action)="connect()"
				icon="mdi mdi-connection"
				severity="info"
				tooltip="Connect" />
			<neb-button
				*ngIf="connected"
				[disabled]="!connection"
				(action)="disconnect()"
				icon="mdi mdi-close"
				severity="danger"
				tooltip="Disconnect" />
		</div>
		<div
			*ngIf="newVersion"
			class="col-12 py-0">
			<div class="m-0 p-message p-message-info w-full flex align-items-center justify-content-between px-2">
				<div class="flex align-items-center">
					<span class="p-message-summary">New version:</span>
					<span class="p-message-detail">{{ newVersion }}</span>
				</div>
				<a
					target="_blank"
					href="https://github.com/tiagohm/nebulosa/releases/latest">
					<neb-button
						icon="mdi mdi-download"
						label="Download"
						severity="info"
						class="py-1 text-blue-900" />
				</a>
			</div>
		</div>
	</div>
	<div
		class="no-scrollbar my-2 overflow-y-auto relative"
		style="height: calc(62px * 5); display: grid; grid-template-columns: repeat(3, minmax(95px, 1fr))"
		(scroll)="scrolled($event)">
		<neb-button-image
			[attr.scroll-page]="0"
			image="assets/icons/camera.png"
			label="Camera"
			imageHeight="32px"
			[disabled]="!connected || !hasCamera"
			(action)="open('CAMERA')" />
		<neb-button-image
			image="assets/icons/telescope.png"
			label="Mount"
			imageHeight="32px"
			[disabled]="!connected || !hasMount"
			(action)="open('MOUNT')" />
		<neb-button-image
			image="assets/icons/guider.png"
			label="Guider"
			imageHeight="32px"
			[disabled]="!connected || !hasGuider"
			(action)="open('GUIDER')" />
		<neb-button-image
			image="assets/icons/filter-wheel.png"
			label="Filter Wheel"
			imageHeight="32px"
			[disabled]="!connected || !hasWheel"
			(action)="open('WHEEL')" />
		<neb-button-image
			image="assets/icons/focus.png"
			label="Focuser"
			imageHeight="32px"
			[disabled]="!connected || !hasFocuser"
			(action)="open('FOCUSER')" />
		<neb-button-image
			image="assets/icons/rotate.png"
			label="Rotator"
			imageHeight="32px"
			[disabled]="!connected || !hasRotator"
			(action)="open('ROTATOR')" />
		<neb-button-image
			image="assets/icons/observatory.png"
			label="Dome"
			imageHeight="32px"
			[disabled]="!connected || !hasDome" />
		<neb-button-image
			image="assets/icons/toolkit.png"
			label="Auxiliary"
			imageHeight="32px"
			[disabled]="!connected || !hasAuxiliary"
			(action)="toggleAuxiliary()" />
		@if (preference.showAuxiliary && hasAuxiliary) {
			<neb-button-image
				image="assets/icons/switch.png"
				label="Switch"
				imageHeight="32px"
				[disabled]="!connected || !hasSwitch" />
			<neb-button-image
				image="assets/icons/light.png"
				label="Light Box"
				imageHeight="32px"
				[disabled]="!connected || !hasLightBox"
				(action)="open('LIGHT_BOX')" />
			<neb-button-image
				image="assets/icons/lid.png"
				label="Dust Cap"
				imageHeight="32px"
				[disabled]="!connected || !hasDustCap"
				(action)="open('DUST_CAP')" />
		}
		<neb-button-image
			image="assets/icons/atlas.png"
			label="Sky Atlas"
			imageHeight="32px"
			(action)="open('SKY_ATLAS')" />
		<neb-button-image
			image="assets/icons/star.png"
			label="Alignment"
			imageHeight="32px"
			[disabled]="!connected || !hasAlignment"
			(action)="open('ALIGNMENT')" />
		<neb-button-image
			image="assets/icons/sequencer.png"
			label="Sequencer"
			imageHeight="32px"
			(action)="open('SEQUENCER')"
			[disabled]="!connected || !hasSequencer" />
		<neb-button-image
			image="assets/icons/image.png"
			label="Image Viewer"
			imageHeight="32px"
			(action)="open('IMAGE')" />
		<neb-button-image
			image="assets/icons/framing.png"
			label="Framing"
			imageHeight="32px"
			(action)="open('FRAMING')" />
		<neb-button-image
			image="assets/icons/auto-focus.png"
			label="Auto Focus"
			imageHeight="32px"
			(action)="open('AUTO_FOCUS')"
			[disabled]="!connected || !hasAutoFocus" />
		<neb-button-image
			image="assets/icons/flat-wizard.png"
			label="Flat Wizard"
			imageHeight="32px"
			(action)="open('FLAT_WIZARD')"
			[disabled]="!connected || !hasFlatWizard" />
		<neb-button-image
			image="assets/icons/calibration.png"
			label="Calibration"
			imageHeight="32px"
			(action)="open('CALIBRATION')" />
		<neb-button-image
			image="assets/icons/indi.png"
			label="INDI"
			imageHeight="32px"
			[disabled]="connection?.type !== 'INDI' || !connected || !hasINDI"
			(action)="open('INDI')" />
		<neb-button-image
			[attr.scroll-page]="1"
			image="assets/icons/calculator.png"
			label="Calculator"
			imageHeight="32px"
			(action)="open('CALCULATOR')" />
		<neb-button-image
			image="assets/icons/settings.png"
			label="Settings"
			imageHeight="32px"
			(action)="open('SETTINGS')" />
		<neb-button-image
			image="assets/icons/about.png"
			label="About"
			imageHeight="32px"
			(action)="open('ABOUT')" />
		<neb-indicator
			[count]="2"
			[(position)]="page"
			(positionChange)="scrollToPage($event)"
			class="fixed"
			style="top: 50%; right: 0.5rem" />
	</div>
</div>

<p-dialog
	header="Connection"
	[modal]="true"
	[draggable]="false"
	[(visible)]="connectionDialog.showDialog"
	[style]="{ width: '90vw' }">
	<div class="grid p-2">
		<div class="col-12">
			<neb-input-text
				label="Name"
				[maxLength]="32"
				[(value)]="connectionDialog.connection.name" />
		</div>
		<div class="col-12">
			<neb-input-text
				label="Host"
				[(value)]="connectionDialog.connection.host" />
		</div>
		<div class="col-4">
			<neb-input-number
				label="Port"
				style="min-width: 80px"
				placeholder="7624"
				[min]="80"
				[max]="65535"
				[(value)]="connectionDialog.connection.port"
				[format]="false" />
		</div>
		<div class="col-8">
			<p-selectButton
				[options]="'CONNECTION_TYPE' | dropdownOptions"
				[(ngModel)]="connectionDialog.connection.type"
				styleClass="border-0 w-full" />
		</div>
	</div>
	<ng-template pTemplate="footer">
		<neb-button
			[disabled]="!connectionDialog.connection.name || !connectionDialog.connection.host || !connectionDialog.connection.port"
			icon="mdi mdi-content-save"
			label="Save"
			(action)="saveConnection()" />
	</ng-template>
</p-dialog>

<neb-device-list-menu
	#deviceMenu
	[disableIfDeviceIsNotConnected]="false"
	(deviceConnect)="deviceConnected($event)"
	(deviceDisconnect)="deviceDisconnected($event)"
	[toolbarBuilder]="deviceMenuToolbarBuilder" />
