<div class="grid">
	<div class="col-12">
		<p-tabView>
			<p-tabPanel
				header="PHD2"
				leftIcon="mdi mdi-target">
				<div class="grid mt-3 px-4 flex align-items-center">
					<div class="col-6 px-0">
						<neb-input-text
							label="Host"
							[disabled]="guider.connected"
							placeholder="localhost"
							[(value)]="preference.host"
							(valueChange)="savePreference()" />
					</div>
					<div class="col-3 pr-0">
						<neb-input-number
							label="Port"
							[disabled]="guider.connected"
							placeholder="7624"
							[(value)]="preference.port"
							(valueChange)="savePreference()"
							[format]="false" />
					</div>
					<div class="col-2 text-center pr-0">
						@if (guider.connected) {
							<neb-button
								(action)="guidingConnect()"
								icon="mdi mdi-close"
								severity="danger"
								tooltip="Disconnect" />
						} @else {
							<neb-button
								(action)="guidingConnect()"
								icon="mdi mdi-connection"
								severity="info"
								tooltip="Connect" />
						}
					</div>
					<div
						class="col-12 pt-0 text-sm text-gray-400 flex align-items-center my-1 gap-1 text-center text-sm"
						style="min-height: 25px">
						<i class="mdi mdi-information text-info"></i>
						<span
							style="min-width: 44px"
							class="text-left mr-2">
							{{ guider.state | enum | lowercase }}
						</span>
						<span class="text-left">{{ guider.message }}</span>
					</div>
					<div class="col-12 align-items-center">
						<p-tabView class="relative">
							<p-tabPanel
								header="Chart"
								leftIcon="mdi mdi-chart-bell-curve">
								<div class="grid mt-2">
									<div class="col-3">
										<neb-input-text
											label="RMS RA"
											[readonly]="true"
											value="{{ chartInfo.rmsRA.toFixed(2) + ' (' + (chartInfo.rmsRA * chartInfo.pixelScale).toFixed(2) + '&quot; )' }}" />
									</div>
									<div class="col-3">
										<neb-input-text
											label="RMS DEC"
											[readonly]="true"
											value="{{ chartInfo.rmsDEC.toFixed(2) + ' (' + (chartInfo.rmsDEC * chartInfo.pixelScale).toFixed(2) + '&quot; )' }}" />
									</div>
									<div class="col-3">
										<neb-input-text
											label="RMS Total"
											[readonly]="true"
											value="{{ chartInfo.rmsTotal.toFixed(2) + ' (' + (chartInfo.rmsTotal * chartInfo.pixelScale).toFixed(2) + '&quot; )' }}" />
									</div>
									<div class="col-3">
										<neb-input-text
											label="Star mass"
											[readonly]="true"
											[value]="guider.step?.starMass ?? 0" />
									</div>
									<div class="col-2">
										<neb-input-text
											label="HFD"
											[readonly]="true"
											[value]="guider.step?.hfd ?? 0" />
									</div>
									<div class="col-2">
										<neb-input-text
											label="SNR"
											[readonly]="true"
											[value]="guider.step?.snr ?? 0" />
									</div>
									<div class="col-4">
										<neb-dropdown-enum
											label="Plot Mode"
											[options]="'GUIDER_PLOT_MODE' | dropdownOptions"
											[(value)]="preference.plotMode"
											(valueChange)="plotModeChanged()" />
									</div>
									<div class="col-4">
										<neb-dropdown-enum
											label="Unit"
											[options]="'GUIDER_Y_AXIS_UNIT' | dropdownOptions"
											[(value)]="preference.yAxisUnit"
											(valueChange)="yAxisUnitChanged()" />
									</div>
								</div>
								<div class="grid relative">
									<div class="col-12">
										<p-chart
											#chart
											width="100%"
											height="140px"
											[data]="chartData"
											[responsive]="true"
											[options]="chartOptions" />
									</div>
									<span
										class="absolute right-0 text-info"
										style="top: 16px">
										North
									</span>
									<span
										class="absolute right-0 text-danger"
										style="bottom: 26px">
										East
									</span>
								</div>
							</p-tabPanel>
							<p-tabPanel
								header="Settings"
								leftIcon="mdi mdi-cog">
								<div class="grid mt-3">
									<div class="col-6">
										<neb-input-number
											label="Settle tolerance (px)"
											[disabled]="guider.connected"
											[min]="1"
											[max]="25"
											[step]="0.1"
											[(value)]="preference.settle.amount"
											(valueChange)="savePreference()" />
									</div>
									<div class="col-6">
										<neb-input-number
											label="Min settle time (s)"
											[disabled]="guider.connected"
											[min]="1"
											[max]="60"
											[(value)]="preference.settle.time"
											(valueChange)="savePreference()" />
									</div>
									<div class="col-6">
										<neb-input-number
											label="Settle timeout (s)"
											[disabled]="guider.connected"
											[min]="1"
											[max]="60"
											[(value)]="preference.settle.timeout"
											(valueChange)="savePreference()" />
									</div>
								</div>
							</p-tabPanel>
							<div
								class="mt-1 absolute"
								style="top: -12px; right: 10px">
								<div class="flex align-items-center justify-content-center gap-1">
									<!-- <neb-button [disabled]="!connected || guiding || looping" label="Start" (onClick)="guidingStart($event)"
                                          icon="mdi mdi-play" severity="success" size="small" [text]="true" /> -->
									<neb-button
										[disabled]="!guider.connected"
										label="Clear"
										(action)="guidingClearHistory()"
										icon="mdi mdi-broom"
										severity="info" />
									<neb-button
										[disabled]="!guider.connected || !guiding"
										label="Stop"
										(action)="guidingStop()"
										icon="mdi mdi-stop"
										severity="danger" />
								</div>
							</div>
						</p-tabView>
					</div>
				</div>
			</p-tabPanel>
			<p-tabPanel
				header="Guide pulse"
				leftIcon="mdi mdi-pulse">
				<div class="grid mt-1 px-4">
					<div class="col-12 mb-2 flex flex-row align-items-center justify-content-center gap-2">
						<neb-device-chooser
							title="GUIDE OUTPUT"
							icon="mdi mdi-target"
							[devices]="guideOutputs"
							[(device)]="guideOutput"
							(deviceChange)="guideOutputChanged()"
							[disabled]="guideOutput?.pulseGuiding" />
					</div>
					<div class="col-4"></div>
					<div class="col-4 flex flex-column gap-2 align-items-center justify-content-center">
						<neb-input-number
							label="North (ms)"
							[disabled]="!guideOutput || !guideOutput.connected || guideOutput.pulseGuiding"
							[(value)]="preference.pulseDuration.north"
							(valueChange)="savePreference()"
							[min]="1"
							[max]="1800000" />
					</div>
					<div class="col-4"></div>
					<div class="col-4 flex flex-row gap-2 align-items-center justify-content-center">
						<neb-input-number
							label="West (ms)"
							[disabled]="!guideOutput || !guideOutput.connected || guideOutput.pulseGuiding"
							[(value)]="preference.pulseDuration.west"
							(valueChange)="savePreference()"
							[min]="1"
							[max]="1800000" />
					</div>
					<div class="col-4">
						<div class="grid">
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('NORTH', 'WEST')"
									icon="mdi mdi-lg mdi-arrow-top-left-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('NORTH')"
									icon="mdi mdi-lg mdi-arrow-up-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('NORTH', 'EAST')"
									icon="mdi mdi-lg mdi-arrow-top-right-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('WEST')"
									icon="mdi mdi-lg mdi-arrow-left-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || !guideOutput?.pulseGuiding"
									(action)="guidePulseStop()"
									icon="mdi mdi-lg mdi-close-circle"
									severity="danger" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('EAST')"
									icon="mdi mdi-lg mdi-arrow-right-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('SOUTH', 'WEST')"
									icon="mdi mdi-lg mdi-arrow-bottom-left-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('SOUTH')"
									icon="mdi mdi-lg mdi-arrow-down-thick" />
							</div>
							<div class="col-4 flex align-items-center justify-content-center">
								<neb-button
									[disabled]="!guideOutput?.connected || guideOutput?.pulseGuiding"
									(action)="guidePulseStart('SOUTH', 'EAST')"
									icon="mdi mdi-lg mdi-arrow-bottom-right-thick" />
							</div>
						</div>
					</div>
					<div class="col-4 flex flex-row gap-2 align-items-center justify-content-center">
						<neb-input-number
							label="East (ms)"
							[disabled]="!guideOutput || !guideOutput.connected || guideOutput.pulseGuiding"
							[(value)]="preference.pulseDuration.east"
							(valueChange)="savePreference()"
							[min]="1"
							[max]="1800000" />
					</div>
					<div class="col-4"></div>
					<div class="col-4 flex flex-column gap-2 align-items-center justify-content-center">
						<neb-input-number
							label="South (ms)"
							[disabled]="!guideOutput || !guideOutput.connected || guideOutput.pulseGuiding"
							[(value)]="preference.pulseDuration.south"
							(valueChange)="savePreference()"
							[min]="1"
							[max]="1800000" />
					</div>
					<div class="col-4"></div>
				</div>
			</p-tabPanel>
		</p-tabView>
	</div>
</div>
