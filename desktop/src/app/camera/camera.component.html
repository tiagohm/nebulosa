<div class="container px-4 py-3">
    <div class="grid py-1 flex align-items-center">
        <div class="col-6">
            <span class="p-float-label">
                <input type="text" pInputText [readonly]="true" [value]="camera.name" class="p-inputtext-sm border-0 w-full" />
                <label>Camera</label>
            </span>
        </div>
        <div class="col-2">
            <p-button *ngIf="!camera || camera.connected" [disabled]="!camera || capturing" (onClick)="connect()" icon="mdi mdi-close"
                      size="small" severity="danger" pTooltip="Disconnect" tooltipPosition="bottom" />
            <p-button *ngIf="!camera.connected" [disabled]="!camera || capturing" (onClick)="connect()" icon="mdi mdi-connection"
                      size="small" severity="info" pTooltip="Connect" tooltipPosition="bottom" />
        </div>
        <div class="col-4 flex justify-content-end align-items-center gap-2">
            <p-button [disabled]="!camera" [text]="true" [rounded]="true" icon="mdi mdi-image-multiple" (click)="openCameraImage()"
                      pTooltip="Image viewer" tooltipPosition="bottom" />
            <p-button [disabled]="!camera" [text]="true" [rounded]="true" icon="mdi mdi-wrench" (click)="openCameraCalibration()"
                      pTooltip="Calibration" tooltipPosition="bottom" />
            <p-button *ngIf="!dialogMode" [disabled]="!camera || !camera.connected || capturing" [text]="true" [rounded]="true"
                      icon="mdi mdi-dots-vertical" (click)="cameraMenu.show()" />
        </div>
        <div *ngIf="!dialogMode" class="col-12 pt-0 text-sm text-gray-400 flex align-items-center gap-1">
            <i *ngIf="request.autoSave" class="mdi mdi-content-save" pTooltip="Auto save: ON" tooltipPosition="bottom"></i>
            <i *ngIf="!request.autoSave" class="mdi mdi-content-save-off" pTooltip="Auto save: OFF" tooltipPosition="bottom"></i>
            <i *ngIf="request.autoSubFolderMode === 'OFF'" class="mdi mdi-folder-off" pTooltip="Auto sub folder: OFF" tooltipPosition="bottom"></i>
            <i *ngIf="request.autoSubFolderMode === 'NOON'" class="mdi mdi-weather-sunny text-yellow-600" pTooltip="Auto sub folder: NOON"
               tooltipPosition="bottom"></i>
            <i *ngIf="request.autoSubFolderMode === 'MIDNIGHT'" class="mdi mdi-weather-night text-blue-600" pTooltip="Auto sub folder: MIDNIGHT"
               tooltipPosition="bottom"></i>
            <span *ngIf="camera && (savePath || capturesPath)" style="padding-top: 1px; padding-bottom: 1px; height: 15px;"
                  class="flex align-items-center gap-2 bg-gray-800 border-round-2xl px-3 text-overflow-scroll">
                {{ savePath || capturesPath }}
                <i *ngIf="savePath" class="mdi mdi-close cursor-pointer" pTooltip="Reset" tooltipPosition="bottom" (click)="clearSavePath()"></i>
            </span>
        </div>
        <div *ngIf="!dialogMode" class="col-12 pt-0 text-sm text-gray-400 flex align-items-center my-1 gap-1 text-center text-sm"
             style="min-height: 25px;">
            <i class="mdi mdi-information text-blue-600"></i>
            <span style="min-width: 44px" class="text-left mr-2">
                {{ settling ? 'settling' : waiting ? 'waiting' : capturing ? 'capturing' : 'idle' }}
            </span>
            <ng-container *ngIf="capturing">
                <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 46px">
                    {{ exposure.count }}
                    <span *ngIf="!capture.looping"> of {{ capture.amount }}</span>
                </span>
            </ng-container>
            <ng-container *ngIf="capturing && !waiting">
                <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                    {{ exposure.remainingTime | exposureTime }}
                </span>
                <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 40px">
                    {{ exposure.progress | percent:'1.1-1' }}
                </span>
            </ng-container>
            <ng-container *ngIf="capturing || waiting">
                <ng-container *ngIf="!capture.looping">
                    <span class="bg-green-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                        {{ capture.remainingTime | exposureTime }}
                    </span>
                    <span class="bg-green-500 border-round-md p-1 text-gray-900" style="min-width: 40px">
                        {{ capture.progress | percent:'1.1-1' }}
                    </span>
                </ng-container>
                <ng-container *ngIf="capture.looping">
                    <span class="bg-green-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                        {{ capture.elapsedTime | exposureTime }}
                    </span>
                </ng-container>
            </ng-container>
            <ng-container *ngIf="waiting">
                <span class="bg-purple-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                    {{ wait.remainingTime | exposureTime }}
                </span>
                <span class="bg-purple-500 border-round-md p-1 text-gray-900" style="min-width: 40px">
                    {{ wait.progress | percent:'1.1-1' }}
                </span>
            </ng-container>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-3 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Cooler ({{ camera.coolerPower | number: '1.1-1' }}%)</span>
            <p-inputSwitch [disabled]="!camera.connected || !camera.hasCooler || capturing" (onChange)="toggleCooler()"
                           [(ngModel)]="camera!.cooler" />
        </div>
        <div class="col-3 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Dew heater</span>
            <p-inputSwitch [disabled]="!camera.connected || !hasDewHeater || capturing" [(ngModel)]="camera!.dewHeater" />
        </div>
        <div class="col-6 flex flex-column">
            <div class="flex justify-content-center align-items-center gap-1">
                <span class="p-float-label">
                    <p-inputNumber [disabled]="!camera.connected || !camera.canSetTemperature || capturing" [(ngModel)]="setpointTemperature"
                                   mode="decimal" [showButtons]="true" (ngModelChange)="savePreference()" [step]="0.1" suffix="℃" [min]="-50"
                                   [max]="50" locale="en" styleClass="p-inputtext-sm border-0" [allowEmpty]="false" [minFractionDigits]="1" />
                    <label>Temperature ({{ camera.temperature | number: '1.1-1' }}°C)</label>
                </span>
                <p-button [disabled]="!camera.connected || !camera.canSetTemperature || capturing" (onClick)="applySetpointTemperature()"
                          icon="mdi mdi-check" styleClass="p-button-sm" severity="success" pTooltip="Apply" tooltipPosition="bottom" />
            </div>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-6">
            <div class="flex justify-content-center align-items-center gap-1">
                <span class="p-float-label">
                    <p-inputNumber [disabled]="!camera.connected || capturing" [(ngModel)]="request.exposureTime" mode="decimal" [showButtons]="true"
                                   [step]="1.0" [min]="exposureTimeMin" [max]="exposureTimeMax" locale="en" styleClass="p-inputtext-sm border-0"
                                   [allowEmpty]="false" (ngModelChange)="savePreference()" />
                    <label>Exposure Time</label>
                </span>
                <p-menu #exposureTimeMenu [model]="exposureTimeUnitModel" [popup]="true" appendTo="body" />
                <button [disabled]="!camera.connected || capturing" pButton type="button" (click)="exposureTimeMenu.toggle($event)"
                        [label]="exposureTimeUnit"></button>
            </div>
        </div>
        <div class="col-6">
            <span class="p-float-label">
                <p-dropdown [disabled]="!camera.connected || capturing" [options]="frameTypeOptions" [(ngModel)]="request.frameType"
                            styleClass="p-inputtext-sm border-0" [autoDisplayFirst]="false"
                            (ngModelChange)="savePreference()" />
                <label>Frame Type</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-6 flex-column">
            <span class="text-sm text-gray-100">Exposure Mode</span>
            <p-selectButton [disabled]="dialogMode || !camera.connected || capturing" [options]="exposureModeOptions" [(ngModel)]="exposureMode"
                            styleClass="p-inputtext-sm border-0"
                            (ngModelChange)="savePreference()" />
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || exposureMode === 'SINGLE' || capturing" [(ngModel)]="request.exposureDelay"
                               mode="decimal" [showButtons]="true" [step]="1" [min]="0" [max]="60" locale="en" styleClass="p-inputtext-sm border-0"
                               [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Delay (s)</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || exposureMode !== 'FIXED' || capturing" [(ngModel)]="request.exposureAmount"
                               mode="decimal" [showButtons]="true" [step]="1.0" [min]="1" [max]="1000" locale="en"
                               styleClass="p-inputtext-sm border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Count</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || !subFrame || capturing" [(ngModel)]="request.x" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="camera.minX" [max]="camera.maxX" locale="en" styleClass="p-inputtext-sm border-0"
                               [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>X</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || !subFrame || capturing" [(ngModel)]="request.y" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="camera.minY" [max]="camera.maxY" locale="en" styleClass="p-inputtext-sm border-0"
                               [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>Y</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || !subFrame || capturing" [(ngModel)]="request.width" mode="decimal"
                               [showButtons]="true" [step]="1.0" [min]="camera.minWidth" [max]="camera.maxWidth" locale="en"
                               styleClass="p-inputtext-sm border-0" [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>Width</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || !subFrame || capturing" [(ngModel)]="request.height" mode="decimal"
                               [showButtons]="true" [step]="1.0" [min]="camera.minHeight" [max]="camera.maxHeight" locale="en"
                               styleClass="p-inputtext-sm border-0" [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>Height</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-3 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Subframe</span>
            <p-inputSwitch [disabled]="!camera.connected || capturing" [(ngModel)]="subFrame" (ngModelChange)="savePreference()" />
        </div>
        <div class="col-3 flex pt-3 flex-row align-items-center justify-content-center">
            <p-button [disabled]="!camera.connected || !subFrame || capturing" icon="mdi mdi-fullscreen" (onClick)="fullsize()"
                      severity="info" pTooltip="Full size" tooltipPosition="bottom" />
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || capturing" [(ngModel)]="request.binX" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="1" [max]="4" styleClass="p-inputtext-sm border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Bin X</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || capturing" [(ngModel)]="request.binY" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="1" [max]="4" styleClass="p-inputtext-sm border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Bin Y</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-6">
            <span class="p-float-label">
                <p-dropdown [disabled]="!camera.connected || capturing" [options]="camera.frameFormats" [(ngModel)]="request.frameFormat"
                            styleClass="p-inputtext-sm border-0" (ngModelChange)="savePreference()" [autoDisplayFirst]="false" />
                <label>Frame Format</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || capturing" [(ngModel)]="request.gain" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="camera.gainMin" [max]="camera.gainMax" styleClass="p-inputtext-sm border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Gain</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || capturing" [(ngModel)]="request.offset" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="camera.offsetMin" [max]="camera.offsetMax" styleClass="p-inputtext-sm border-0"
                               [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>Offset</label>
            </span>
        </div>
    </div>
    <div class="grid mt-1">
        <div class="col-12 flex align-items-center justify-content-center gap-1">
            <p-button *ngIf="!dialogMode" [disabled]="!camera.connected || capturing" label="Start" (onClick)="startCapture()" icon="mdi mdi-play"
                      severity="success" />
            <p-button *ngIf="!dialogMode" [disabled]="!camera.connected || !capturing" label="Abort" (onClick)="abortCapture()" icon="mdi mdi-stop"
                      severity="danger" />
            <p-button *ngIf="dialogMode" [disabled]="!camera.connected" label="Save" (onClick)="apply()" icon="mdi mdi-content-save"
                      severity="info" />
        </div>
    </div>
</div>

<p-dialogMenu #cameraMenu [model]="cameraModel" />

<p-dialog header="Dither" [draggable]="true" [(visible)]="showDitherDialog" [modal]="true" [style]="{width: '80vw', maxWidth: '260px'}">
    <div class="grid mt-2">
        <div class="col-6 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Enabled</span>
            <p-inputSwitch [disabled]="!camera.connected || capturing" [(ngModel)]="request.dither!.enabled" (ngModelChange)="savePreference()" />
        </div>
        <div class="col-6">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || capturing || !request.dither!.enabled" [showButtons]="true"
                               styleClass="border-0 p-inputtext-sm w-full" [min]="0.1" [max]="60" [(ngModel)]="request.dither!.amount" [step]="0.1"
                               locale="en" [minFractionDigits]="1" (ngModelChange)="savePreference()" />
                <label>Dither (px)</label>
            </span>
        </div>
        <div class="col-6 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Dither in RA only</span>
            <p-checkbox [binary]="true" [disabled]="!camera.connected || capturing || !request.dither!.enabled"
                        [(ngModel)]="request.dither!.raOnly" (ngModelChange)="savePreference()" />
        </div>
        <div class="col-6">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!camera.connected || capturing || !request.dither!.enabled" [showButtons]="true"
                               styleClass="border-0 p-inputtext-sm w-full" [min]="1" [max]="1000"
                               [(ngModel)]="request.dither!.afterExposures" [step]="1" (ngModelChange)="savePreference()" />
                <label>After exposures</label>
            </span>
        </div>
    </div>
</p-dialog>