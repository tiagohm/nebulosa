<div class="container px-4 pt-2 pb-1">
	<div class="grid py-1 flex align-items-center">
		<div class="col-8 align-items-center gap-2">
			<neb-device-name [device]="camera" />
			@if (camera.connected) {
				<neb-button
					[disabled]="running"
					(action)="connect()"
					icon="mdi mdi-close"
					severity="danger"
					tooltip="Disconnect" />
			} @else {
				<neb-button
					[disabled]="running"
					(action)="connect()"
					icon="mdi mdi-connection"
					severity="info"
					tooltip="Connect" />
			}
		</div>
		<div class="col-4 flex justify-content-end align-items-center gap-2">
			<neb-button
				[disabled]="!camera"
				icon="mdi mdi-image-multiple"
				(action)="openCameraImage()"
				tooltip="View image" />
			<neb-button
				*ngIf="hasCalibration"
				[disabled]="!camera"
				icon="mdi mdi-wrench"
				(action)="calibrationMenu.show()"
				tooltip="Calibration" />
			<neb-button
				*ngIf="canShowMenu"
				[disabled]="!camera || !camera.connected || running"
				icon="mdi mdi-dots-vertical"
				(action)="cameraMenu.show()" />
		</div>
		<div
			*ngIf="canShowSavePath"
			class="col-12 py-0 text-sm text-gray-400 flex align-items-center gap-2">
			<i
				*ngIf="request.autoSave"
				class="mdi mdi-content-save cursor-pointer"
				(click)="toggleAutoSaveAllExposures()"
				pTooltip="Auto save: ON"
				tooltipPosition="bottom"
				[positionLeft]="24"
				[positionTop]="8"></i>
			<i
				*ngIf="!request.autoSave"
				class="mdi mdi-content-save-off cursor-pointer"
				(click)="toggleAutoSaveAllExposures()"
				pTooltip="Auto save: OFF"
				tooltipPosition="bottom"
				[positionLeft]="24"
				[positionTop]="8"></i>
			<i
				*ngIf="request.autoSubFolderMode === 'OFF'"
				(click)="toggleAutoSubFolder()"
				class="mdi mdi-folder-off cursor-pointer"
				pTooltip="Auto sub folder: OFF"
				tooltipPosition="bottom"
				[positionLeft]="24"
				[positionTop]="8"></i>
			<i
				*ngIf="request.autoSubFolderMode === 'NOON'"
				(click)="toggleAutoSubFolder()"
				class="mdi mdi-weather-sunny text-yellow-600 cursor-pointer"
				pTooltip="Auto sub folder: NOON"
				tooltipPosition="bottom"
				[positionLeft]="24"
				[positionTop]="8"></i>
			<i
				*ngIf="request.autoSubFolderMode === 'MIDNIGHT'"
				(click)="toggleAutoSubFolder()"
				class="mdi mdi-weather-night text-info cursor-pointer"
				pTooltip="Auto sub folder: MIDNIGHT"
				tooltipPosition="bottom"
				[positionLeft]="32"
				[positionTop]="8"></i>
			<span
				*ngIf="camera && (preference.request.savePath || camera.capturesPath)"
				style="padding-top: 1px; padding-bottom: 1px; height: 14px"
				class="flex flex-1 align-items-center gap-2 bg-gray-800 border-round px-3 text-overflow-scroll">
				<i
					class="mdi mdi-folder-open cursor-pointer"
					pTooltip="Choose new folder"
					tooltipPosition="bottom"
					(click)="chooseSavePath()"
					[positionTop]="8"></i>
				<i
					*ngIf="preference.request.savePath || camera.capturesPath"
					class="mdi mdi-close cursor-pointer"
					pTooltip="Reset"
					tooltipPosition="bottom"
					(click)="clearSavePath()"
					[positionTop]="8"></i>
				{{ preference.request.savePath || camera.capturesPath }}
			</span>
		</div>
		<div
			*ngIf="canShowInfo"
			class="col-12 pt-0 pb-1 text-sm text-gray-400 flex align-items-center my-1 gap-1 text-center text-xs">
			<neb-camera-exposure #cameraExposure />
		</div>
	</div>
	<div class="grid py-1 flex align-items-center">
		<div class="col-3 flex flex-column justify-content-center text-center">
			<neb-switch
				label="Cooler ({{ camera.coolerPower | number: '1.1-1' }}%)"
				[disabled]="!camera.connected || !camera.hasCooler || running"
				[(value)]="camera!.cooler"
				(valueChange)="toggleCooler()" />
		</div>
		<div class="col-3 flex flex-column justify-content-center text-center">
			<neb-switch
				label="Dew heater"
				[disabled]="!camera.connected || !hasDewHeater || running"
				[(value)]="camera!.dewHeater" />
		</div>
		<div class="col-6 flex flex-column">
			<div class="flex justify-content-center align-items-center gap-1">
				<neb-input-number
					label="Temperature ({{ camera.temperature | number: '1.1-1' }}°C)"
					[disabled]="!camera.connected || !camera.canSetTemperature || running"
					[(value)]="preference.setpointTemperature"
					(valueChange)="savePreference()"
					[step]="0.1"
					suffix="℃"
					[min]="-50"
					[max]="50" />
				<neb-button
					[disabled]="!camera.connected || !camera.canSetTemperature || running"
					(action)="applySetpointTemperature()"
					icon="mdi mdi-check"
					severity="success"
					tooltip="Apply" />
			</div>
		</div>
	</div>
	<div class="grid py-1 flex align-items-center">
		<div class="col-6">
			<neb-exposure-time
				[(exposureTime)]="request.exposureTime"
				[(unit)]="preference.exposureTimeUnit"
				[disabled]="!camera.connected || running"
				[canExposureTime]="canExposureTime"
				[canExposureTimeUnit]="canExposureTimeUnit"
				[min]="camera.exposureMin"
				[max]="camera.exposureMax"
				[normalized]="mode !== 'CAPTURE'"
				(exposureTimeChange)="savePreference()"
				(unitChange)="savePreference()"
				class="w-full" />
		</div>
		<div class="col-6">
			<p-floatLabel class="w-full">
				<p-dropdown
					[disabled]="!canFrameType || !camera.connected || running"
					[options]="'FRAME_TYPE' | dropdownOptions | enumDropdown"
					[(ngModel)]="request.frameType"
					optionLabel="label"
					optionValue="value"
					styleClass="p-inputtext-sm border-0"
					[autoDisplayFirst]="false"
					(ngModelChange)="savePreference()" />
				<label>Frame Type</label>
			</p-floatLabel>
		</div>
	</div>
	<div class="grid py-1 flex align-items-center">
		<div class="col-6 flex-column">
			<span class="text-xs text-gray-100">Exposure Mode</span>
			<p-selectButton
				[disabled]="!canExposureMode || !camera.connected || running"
				[options]="'EXPOSURE_MODE' | dropdownOptions | enumDropdown"
				[(ngModel)]="preference.exposureMode"
				optionLabel="label"
				optionValue="value"
				styleClass="p-button-sm border-0"
				(ngModelChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Delay (s)"
				[disabled]="!camera.connected || preference.exposureMode === 'SINGLE' || running"
				[min]="0"
				[max]="60"
				[(value)]="request.exposureDelay"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Count"
				[disabled]="!canExposureAmount || !camera.connected || preference.exposureMode !== 'FIXED' || running"
				[min]="1"
				[max]="1000"
				[(value)]="request.exposureAmount"
				(valueChange)="savePreference()" />
		</div>
	</div>
	<div class="grid py-1 flex align-items-center">
		<div class="col-3">
			<neb-input-number
				label="X"
				[disabled]="!camera.connected || !preference.subFrame || running"
				[min]="camera.minX"
				[max]="camera.maxX"
				[(value)]="request.x"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Y"
				[disabled]="!camera.connected || !preference.subFrame || running"
				[min]="camera.minY"
				[max]="camera.maxY"
				[(value)]="request.y"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Width"
				[disabled]="!camera.connected || !preference.subFrame || running"
				[min]="camera.minWidth"
				[max]="camera.maxWidth"
				[(value)]="request.width"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Height"
				[disabled]="!camera.connected || !preference.subFrame || running"
				[min]="camera.minHeight"
				[max]="camera.maxHeight"
				[(value)]="request.height"
				(valueChange)="savePreference()" />
		</div>
	</div>
	<div class="grid py-1 flex align-items-center">
		<div class="col-3 flex flex-row align-items-center justify-content-center">
			<neb-switch
				label="Subframe"
				[disabled]="!camera.connected || running"
				[(value)]="preference.subFrame"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3 flex flex-row align-items-center justify-content-center">
			<neb-button
				[disabled]="!camera.connected || running"
				icon="mdi mdi-fullscreen"
				(action)="fullsize()"
				severity="info"
				tooltip="Full size" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Bin X"
				[disabled]="!camera.connected || running"
				[min]="1"
				[max]="4"
				[(value)]="request.binX"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Bin Y"
				[disabled]="!camera.connected || running"
				[min]="1"
				[max]="4"
				[(value)]="request.binY"
				(valueChange)="savePreference()" />
		</div>
	</div>
	<div class="grid py-1 flex align-items-center">
		<div class="col-6">
			<p-floatLabel class="w-full">
				<p-dropdown
					[disabled]="!camera.connected || running || !camera.frameFormats.length"
					[options]="camera.frameFormats"
					[(ngModel)]="request.frameFormat"
					styleClass="p-inputtext-sm border-0"
					(ngModelChange)="savePreference()"
					[autoDisplayFirst]="false" />
				<label>Frame Format</label>
			</p-floatLabel>
		</div>
		<div class="col-3">
			<neb-input-number
				label="Gain"
				[disabled]="!camera.connected || running"
				[min]="camera.gainMin"
				[max]="camera.gainMax"
				[(value)]="request.gain"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-3">
			<neb-input-number
				label="Offset"
				[disabled]="!camera.connected || running || !camera.offsetMax"
				[min]="camera.offsetMin"
				[max]="camera.offsetMax"
				[(value)]="request.offset"
				(valueChange)="savePreference()" />
		</div>
	</div>
	<div class="grid mt-0">
		<div class="col-12 gap-1 justify-content-center align-items-center flex-wrap">
			<p-tag
				*ngIf="hasCalibration"
				icon="mdi mdi-wrench mdi-sm"
				value="{{ request.calibrationGroup || 'None' }}"
				styleClass="cursor-pointer text-xs"
				severity="info"
				(click)="calibrationMenu.show()" />
			<p-tag
				*ngIf="hasDither"
				icon="mdi mdi-pulse mdi-sm"
				value="Dither: {{ request.dither.enabled ? 'ON' : 'OFF' }}"
				styleClass="cursor-pointer text-xs"
				severity="info"
				(click)="dither.showDialog = true" />
			<p-tag
				*ngIf="hasLiveStacking"
				icon="mdi mdi-image-multiple mdi-sm"
				value="Live stacking: {{ request.liveStacking.enabled ? 'ON' : 'OFF' }}"
				styleClass="cursor-pointer text-xs"
				severity="info"
				(click)="liveStacking.showDialog = true" />
			<p-tag
				*ngIf="preference.mount"
				icon="mdi mdi-telescope mdi-sm"
				[value]="preference.mount.name"
				[severity]="preference.mount.connected ? 'success' : 'danger'"
				styleClass="cursor-pointer text-xs"
				(click)="openMount(preference.mount)" />
			<p-tag
				*ngIf="preference.focuser"
				icon="mdi mdi-image-filter-center-focus mdi-sm"
				[value]="preference.focuser.name"
				[severity]="preference.focuser.connected ? 'success' : 'danger'"
				styleClass="cursor-pointer text-xs"
				(click)="openFocuser(preference.focuser)" />
			<p-tag
				*ngIf="preference.wheel"
				icon="mdi mdi-palette mdi-sm"
				value="{{ preference.wheel.name }}: {{ currentWheelFilter }}"
				[severity]="preference.wheel.connected ? 'success' : 'danger'"
				styleClass="cursor-pointer text-xs"
				(click)="openWheel(preference.wheel)" />
			<p-tag
				*ngIf="preference.rotator"
				icon="mdi mdi-rotate-right mdi-sm"
				[value]="preference.rotator.name"
				[severity]="preference.rotator.connected ? 'success' : 'danger'"
				styleClass="cursor-pointer text-xs"
				(click)="openRotator(preference.rotator)" />
		</div>
		<div class="col-12 flex align-items-center justify-content-center gap-1">
			@if (pausingOrPaused) {
				<neb-button
					*ngIf="canStartOrAbort"
					[disabled]="status === 'PAUSING'"
					label="Unpause"
					(action)="unpauseCapture()"
					icon="mdi mdi-play"
					severity="success" />
			} @else if (!running) {
				<neb-button
					*ngIf="canStartOrAbort"
					[disabled]="!camera.connected || running"
					label="Start"
					(action)="startCapture()"
					icon="mdi mdi-play"
					severity="success" />
			}
			<neb-button
				*ngIf="canStartOrAbort && running && !pausingOrPaused"
				label="Pause"
				(action)="pauseCapture()"
				icon="mdi mdi-pause"
				severity="info" />
			<neb-button
				*ngIf="canStartOrAbort"
				[disabled]="!camera.connected || !running"
				label="Abort"
				(action)="abortCapture()"
				icon="mdi mdi-stop"
				severity="danger" />
			<neb-button
				*ngIf="canSave"
				[disabled]="!camera.connected"
				label="Save"
				(action)="apply()"
				icon="mdi mdi-content-save"
				severity="info" />
		</div>
	</div>
</div>

<neb-dialog-menu
	#calibrationMenu
	[model]="calibrationModel"
	header="Calibration" />
<neb-dialog-menu
	#cameraMenu
	[model]="cameraModel"
	header="Camera" />

<p-dialog
	header="Dither"
	[draggable]="true"
	[(visible)]="dither.showDialog"
	[modal]="true"
	[style]="{ width: '80vw', maxWidth: '320px' }">
	<ng-template pTemplate="header">
		<div class="flex w-full align-items-center justify-content-start gap-2 ng-star-inserted">
			<span class="p-dialog-title">Dither</span>
			<div class="flex-1 align-items-center justify-content-center">
				<neb-switch
					label="Enabled"
					[(value)]="dither.request.enabled"
					(valueChange)="savePreference()" />
			</div>
		</div>
	</ng-template>
	<div class="grid mt-2">
		<div class="col-3 flex flex-column justify-content-center text-center">
			<neb-switch
				label="RA only"
				[disabled]="!camera.connected || running || !dither.request.enabled"
				[(value)]="dither.request.raOnly"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-4">
			<neb-input-number
				label="Dither (px)"
				[disabled]="!camera.connected || running || !dither.request.enabled"
				[min]="0.1"
				[max]="60"
				[step]="0.1"
				[(value)]="dither.request.amount"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-5">
			<neb-input-number
				label="After exposures"
				[disabled]="!camera.connected || running || !dither.request.enabled"
				[min]="1"
				[max]="1000"
				[(value)]="dither.request.afterExposures"
				(valueChange)="savePreference()" />
		</div>
	</div>
</p-dialog>

<p-dialog
	[draggable]="true"
	[(visible)]="liveStacking.showDialog"
	[modal]="true"
	[style]="{ width: '80vw', maxWidth: '320px' }">
	<ng-template pTemplate="header">
		<div class="flex w-full align-items-center justify-content-start gap-2 ng-star-inserted">
			<span class="p-dialog-title">Live Stacking</span>
			<div class="flex-1 align-items-center justify-content-center">
				<neb-switch
					label="Enabled"
					[(value)]="liveStacking.request.enabled"
					(valueChange)="savePreference()" />
			</div>
		</div>
	</ng-template>
	<div class="grid mt-2">
		<div class="col-8 align-items-center">
			<p-floatLabel class="w-full">
				<p-dropdown
					[disabled]="!liveStacking.request.enabled"
					[options]="'LIVE_STACKER' | dropdownOptions | enumDropdown"
					[(ngModel)]="liveStacking.request.type"
					optionsLabel="label"
					optionsValue="value"
					styleClass="p-inputtext-sm border-0"
					(ngModelChange)="savePreference()"
					[autoDisplayFirst]="false" />
				<label>Live Stacker</label>
			</p-floatLabel>
		</div>
		<div class="col-4">
			<neb-switch
				label="32-bit (slower)"
				[disabled]="!liveStacking.request.enabled"
				[(value)]="liveStacking.request.use32Bits"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-12 align-items-center">
			<neb-checkbox
				[disabled]="!liveStacking.request.enabled"
				label="Use Camera's calibration group"
				[(value)]="liveStacking.request.useCalibrationGroup"
				(valueChange)="savePreference()" />
		</div>
		<div class="col-12 align-items-center">
			<neb-path-chooser
				[disabled]="!liveStacking.request.enabled || liveStacking.request.useCalibrationGroup"
				[directory]="false"
				label="Dark File"
				key="liveStackerDarkFile"
				[(path)]="liveStacking.request.darkPath"
				class="w-full"
				(pathChange)="savePreference()" />
		</div>
		<div class="col-12 align-items-center">
			<neb-path-chooser
				[disabled]="!liveStacking.request.enabled || liveStacking.request.useCalibrationGroup"
				[directory]="false"
				label="Flat File"
				key="liveStackerFlatFile"
				[(path)]="liveStacking.request.flatPath"
				class="w-full"
				(pathChange)="savePreference()" />
		</div>
		<div class="col-12 align-items-center">
			<neb-path-chooser
				[disabled]="!liveStacking.request.enabled || liveStacking.request.type !== 'PIXINSIGHT' || liveStacking.request.useCalibrationGroup"
				[directory]="false"
				label="Bias File"
				key="liveStackerDarkFile"
				[(path)]="liveStacking.request.biasPath"
				class="w-full"
				(pathChange)="savePreference()" />
		</div>
	</div>
</p-dialog>

<p-dialog
	[draggable]="true"
	[(visible)]="namingFormat.showDialog"
	[modal]="true"
	header="Naming Format"
	[style]="{ width: '80vw', maxWidth: '320px' }">
	<div class="grid mt-2">
		<div class="col-12 gap-1">
			<neb-input-text
				label="Light"
				[(value)]="namingFormat.format.light"
				(valueChange)="savePreference()" />
			<neb-button
				icon="mdi mdi-restore"
				(action)="resetCameraCaptureNamingFormat('LIGHT')"
				tooltip="Reset" />
		</div>
		<div class="col-12 gap-1">
			<neb-input-text
				label="Dark"
				[(value)]="namingFormat.format.dark"
				(valueChange)="savePreference()" />
			<neb-button
				icon="mdi mdi-restore"
				(action)="resetCameraCaptureNamingFormat('DARK')"
				tooltip="Reset" />
		</div>
		<div class="col-12 gap-1">
			<neb-input-text
				label="Flat"
				[(value)]="namingFormat.format.flat"
				(valueChange)="savePreference()" />
			<neb-button
				icon="mdi mdi-restore"
				(action)="resetCameraCaptureNamingFormat('FLAT')"
				tooltip="Reset" />
		</div>
		<div class="col-12 gap-1">
			<neb-input-text
				label="Bias"
				[(value)]="namingFormat.format.bias"
				(valueChange)="savePreference()" />
			<neb-button
				icon="mdi mdi-restore"
				(action)="resetCameraCaptureNamingFormat('BIAS')"
				tooltip="Reset" />
		</div>
	</div>
</p-dialog>
