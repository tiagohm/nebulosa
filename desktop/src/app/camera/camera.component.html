<div class="container p-4">
    <div class="grid py-1 flex align-items-center">
        <div class="col-8">
            <span class="p-float-label">
                <p-dropdown [disabled]="capturing" [options]="cameras" [(ngModel)]="camera" optionLabel="name" (ngModelChange)="cameraChanged()"
                            styleClass="border-0" emptyMessage="No camera found" />
                <label>Camera</label>
            </span>
        </div>
        <div class="col-2">
            <p-button *ngIf="connected" [disabled]="!camera || capturing" (onClick)="connect()" icon="mdi mdi-close"
                      styleClass="p-button-danger" pTooltip="Disconnect" tooltipPosition="bottom" />
            <p-button *ngIf="!connected" [disabled]="!camera || capturing" (onClick)="connect()" icon="mdi mdi-connection"
                      styleClass="p-button-info" pTooltip="Connect" tooltipPosition="bottom" />
        </div>
        <div class="col-2 flex justify-content-center">
            <p-button [disabled]="!camera || capturing" icon="mdi mdi-lg mdi-dots-vertical" (click)="cameraDialogMenu.show()"
                      styleClass="p-button-rounded p-button-text" />
        </div>
        <div class="col-12 pt-0 text-sm text-gray-400 flex align-items-center gap-1">
            <i *ngIf="autoSave" class="mdi mdi-content-save" pTooltip="Auto save: ON" tooltipPosition="bottom"></i>
            <i *ngIf="!autoSave" class="mdi mdi-content-save-off" pTooltip="Auto save: OFF" tooltipPosition="bottom"></i>
            <i *ngIf="autoSubFolderMode === 'OFF'" class="mdi mdi-folder-off" pTooltip="Auto sub folder: OFF" tooltipPosition="bottom"></i>
            <i *ngIf="autoSubFolderMode === 'NOON'" class="mdi mdi-weather-sunny text-yellow-600" pTooltip="Auto sub folder: NOON"
               tooltipPosition="bottom"></i>
            <i *ngIf="autoSubFolderMode === 'MIDNIGHT'" class="mdi mdi-weather-night text-blue-600" pTooltip="Auto sub folder: MIDNIGHT"
               tooltipPosition="bottom"></i>
            <span *ngIf="camera" style="padding-top: 1px; padding-bottom: 1px; min-height: 17px;"
                  class="flex align-items-center gap-2 bg-gray-800 border-round-2xl px-3">
                {{ savePath || capturesPath }}
                <i *ngIf="savePath" class="mdi mdi-close cursor-pointer" pTooltip="Reset" tooltipPosition="bottom" (click)="resetSavePath()"></i>
            </span>
        </div>
        <div class="col-12 pt-0 text-sm text-gray-400 flex align-items-center my-1 gap-1 text-center text-sm" style="min-height: 25px;">
            <i class="mdi mdi-information text-blue-600"></i>
            <span style="min-width: 44px" class="text-left mr-2">{{ waiting ? 'waiting' : capturing ? 'capturing' : 'idle' }}</span>
            <ng-container *ngIf="capturing && event">
                <ng-container *ngIf="!event.captureInLoop">
                    <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 46px">
                        {{ event.exposureCount }} of {{ event.exposureAmount }}
                    </span>
                </ng-container>
                <ng-container *ngIf="event.captureInLoop">
                    <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 34px">
                        {{ event.exposureCount }}
                    </span>
                </ng-container>
                <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                    {{ event.exposureRemainingTime | exposureTime }}
                </span>
                <span class="bg-cyan-500 border-round-md p-1 text-gray-900" style="min-width: 40px">
                    {{ event.exposureProgress | percent:'1.1-1' }}
                </span>
                <ng-container *ngIf="!event.captureInLoop">
                    <span class="bg-green-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                        {{ event.captureRemainingTime | exposureTime }}
                    </span>
                    <span class="bg-green-500 border-round-md p-1 text-gray-900" style="min-width: 40px">
                        {{ event.captureProgress | percent:'1.1-1' }}
                    </span>
                </ng-container>
                <ng-container *ngIf="event.captureInLoop">
                    <span class="bg-green-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                        {{ event.captureElapsedTime | exposureTime }}
                    </span>
                </ng-container>
            </ng-container>
            <ng-container *ngIf="waiting && event">
                <span class="bg-purple-500 border-round-md p-1 text-gray-900" style="min-width: 50px">
                    {{ event.waitRemainingTime | exposureTime }}
                </span>
            </ng-container>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-3 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Cooler ({{ coolerPower | number: '1.1-1' }}%)</span>
            <p-inputSwitch [disabled]="!connected || !hasCooler || capturing" (onChange)="toggleCooler()" [(ngModel)]="cooler" />
        </div>
        <div class="col-3 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Dew heater</span>
            <p-inputSwitch [disabled]="!connected || !hasDewHeater || capturing" [(ngModel)]="dewHeater" />
        </div>
        <div class="col-6 flex flex-column">
            <div class="flex justify-content-center align-items-center gap-1">
                <span class="p-float-label">
                    <p-inputNumber [disabled]="!connected || !canSetTemperature || capturing" [(ngModel)]="setpointTemperature" mode="decimal"
                                   [showButtons]="true" (ngModelChange)="savePreference()"
                                   [step]="0.1" suffix="℃" [min]="-50" [max]="50" locale="en" styleClass="border-0" [allowEmpty]="false" />
                    <label>Temperature ({{ temperature | number: '1.1-1' }}°C)</label>
                </span>
                <p-button [disabled]="!connected || !canSetTemperature || capturing" (onClick)="applySetpointTemperature()" icon="mdi mdi-check"
                          styleClass="p-button-success" pTooltip="Apply" tooltipPosition="bottom" />
            </div>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-6">
            <div class="flex justify-content-center align-items-center gap-1">
                <span class="p-float-label">
                    <p-inputNumber [disabled]="!connected || capturing" [(ngModel)]="exposureTime" mode="decimal" [showButtons]="true"
                                   [step]="1.0" [min]="exposureTimeMin" [max]="exposureTimeMax" locale="en" styleClass="border-0"
                                   [allowEmpty]="false" (ngModelChange)="savePreference()" />
                    <label>Exposure Time</label>
                </span>
                <p-menu #exposureTimeMenu [model]="exposureTimeUnitOptions" [popup]="true" />
                <button [disabled]="!connected || capturing" pButton type="button" (click)="exposureTimeMenu.toggle($event)"
                        [label]="exposureTimeUnit"></button>
            </div>
        </div>
        <div class="col-6">
            <span class="p-float-label">
                <p-dropdown [disabled]="!connected || capturing" [options]="frameTypeOptions" [(ngModel)]="frameType" styleClass="border-0"
                            (ngModelChange)="savePreference()" />
                <label>Frame Type</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-6">
            <span class="text-sm text-gray-100">Exposure Mode</span>
            <p-selectButton [disabled]="!connected || capturing" [options]="exposureModeOptions" [(ngModel)]="exposureMode" styleClass="border-0"
                            (ngModelChange)="savePreference()" />
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || exposureMode === 'SINGLE' || capturing" [(ngModel)]="exposureDelay" mode="decimal"
                               [showButtons]="true" [step]="1" [min]="0" [max]="60" locale="en" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Delay (s)</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || exposureMode !== 'FIXED' || capturing" [(ngModel)]="exposureCount" mode="decimal"
                               [showButtons]="true" [step]="1.0" [min]="1" [max]="1000" locale="en" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Count</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || !subFrame || capturing" [(ngModel)]="x" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="minX" [max]="maxX" locale="en" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>X</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || !subFrame || capturing" [(ngModel)]="y" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="minY" [max]="maxY" locale="en" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Y</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || !subFrame || capturing" [(ngModel)]="width" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="minWidth" [max]="maxWidth" locale="en" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Width</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || !subFrame || capturing" [(ngModel)]="height" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="minHeight" [max]="maxHeight" locale="en" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Height</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-3 flex flex-column justify-content-center text-center gap-2">
            <span class="text-sm text-gray-100">Subframe</span>
            <p-inputSwitch [disabled]="!connected || capturing" [(ngModel)]="subFrame" (ngModelChange)="savePreference()" />
        </div>
        <div class="col-3 flex pt-3 flex-row align-items-center justify-content-center">
            <p-button [disabled]="!connected || !subFrame || capturing" icon="mdi mdi-fullscreen" (onClick)="fullsize()"
                      styleClass="p-button-info" pTooltip="Full size" tooltipPosition="bottom" />
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || capturing" [(ngModel)]="binX" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="1" [max]="4" styleClass="border-0" [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>Bin X</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || capturing" [(ngModel)]="binY" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="1" [max]="4" styleClass="border-0" [allowEmpty]="false" (ngModelChange)="savePreference()" />
                <label>Bin Y</label>
            </span>
        </div>
    </div>
    <div class="grid py-1 flex align-items-center">
        <div class="col-6">
            <span class="p-float-label">
                <p-dropdown [disabled]="!connected || capturing" [options]="frameFormats" [(ngModel)]="frameFormat" styleClass="border-0"
                            (ngModelChange)="savePreference()" [autoDisplayFirst]="false" />
                <label>Frame Format</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || capturing" [(ngModel)]="gain" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="gainMin" [max]="gainMax" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Gain</label>
            </span>
        </div>
        <div class="col-3">
            <span class="p-float-label">
                <p-inputNumber [disabled]="!connected || capturing" [(ngModel)]="offset" mode="decimal" [showButtons]="true"
                               [step]="1.0" [min]="offsetMin" [max]="offsetMax" styleClass="border-0" [allowEmpty]="false"
                               (ngModelChange)="savePreference()" />
                <label>Offset</label>
            </span>
        </div>
    </div>
    <div class="grid mt-1">
        <div class="col-12 flex align-items-center justify-content-center gap-1">
            <p-button [disabled]="!connected || capturing" label="Start" (onClick)="startCapture()" icon="mdi mdi-play"
                      styleClass="p-button-success" />
            <p-button [disabled]="!connected || !capturing" label="Abort" (onClick)="abortCapture()" icon="mdi mdi-stop"
                      styleClass="p-button-danger" />
        </div>
    </div>
</div>

<dialogMenu #cameraDialogMenu [model]="cameraMenuItems" />